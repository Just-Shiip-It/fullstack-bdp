<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LifeDrop ‚Äî Donor Portal</title>
  <meta name="description" content="Your LifeDrop donor portal: dashboard, schedule, history, and profile." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
    rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { jakarta: ['Plus Jakarta Sans', 'ui-sans-serif', 'system-ui'] }, colors: { blood: { 50: '#fff1f2', 400: '#fb7185', 500: '#ef4444', 600: '#dc2626' }, coal: { 900: '#0b0b10' } }, boxShadow: { glow: '0 10px 40px -5px rgba(239,68,68,0.45)' } } } };
  </script>
  <style>
    :root {
      --bg: #0b0b10;
      --card: rgba(255, 255, 255, .08);
      --border: rgba(255, 255, 255, .12)
    }

    body {
      min-height: 100vh;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(239, 68, 68, .12), transparent), radial-gradient(900px 500px at 90% 10%, rgba(244, 63, 94, .10), transparent), linear-gradient(180deg, #0b0b10 0%, #0b0b10 40%, #0f1115 100%)
    }

    .glass {
      background: var(--card);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border)
    }

    .tab {
      display: none
    }

    .tab.active {
      display: block
    }

    .shine {
      position: relative;
      overflow: hidden
    }

    .shine:after {
      content: '';
      position: absolute;
      inset: -200% -50%;
      background: linear-gradient(120deg, transparent 30%, rgba(255, 255, 255, .18) 48%, transparent 70%);
      transform: translateX(-100%);
      animation: shine 6s infinite
    }

    @keyframes pulseSoft {

      0%,
      100% {
        opacity: .9
      }

      50% {
        opacity: 1
      }
    }
  </style>
</head>

<body class="font-jakarta text-slate-100 antialiased">
  <div class="min-h-[100dvh] grid lg:grid-cols-[260px_1fr]">
    <!-- Sidebar -->
    <aside class="glass border-r border-white/10 p-4 lg:p-6 flex flex-col gap-4">
      <a href="blood-donation-landing.html" class="flex items-center gap-2">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
          <path d="M12 2c4 4 6 7.5 6 10.5A6 6 0 1 1 6 12.5C6 9.5 8 6 12 2Z" fill="#ef4444" />
        </svg>
        <span class="text-lg font-extrabold">LifeDrop</span>
      </a>
      <nav class="mt-2 grid gap-1 text-sm" id="sidebarLinks">
        <a data-tab="dashboard"
          class="px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2 active-link"><span>üè†</span>Dashboard</a>
        <a data-tab="schedule"
          class="px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"><span>üóìÔ∏è</span>Schedule</a>
        <a data-tab="history"
          class="px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"><span>üßæ</span>History</a>
        <a data-tab="profile"
          class="px-3 py-2 rounded-lg hover:bg-white/5 flex items-center gap-2"><span>üë§</span>Profile</a>
      </nav>
      <div class="mt-auto grid gap-2 text-xs text-slate-300">
        <div class="flex items-center gap-2 p-3 rounded-xl bg-white/5 border border-white/10">
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-blood-500/40 to-rose-500/40 grid place-items-center">
            üíß</div>
          <div class="leading-tight">
            <div id="userName" class="font-semibold">Donor</div>
            <div id="userGroup" class="text-slate-400">‚Äî</div>
          </div>
        </div>
        <button id="logout" class="px-3 py-2 rounded-lg border border-white/10 hover:bg-white/5">Sign out</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="p-5 md:p-8">
      <!-- Topbar -->
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold" id="pageTitle">Dashboard</h1>
          <p class="text-slate-300 text-sm">Welcome back! Here‚Äôs your donation snapshot.</p>
        </div>
        <div class="flex items-center gap-2">
          <a data-tab="schedule"
            class="shine px-4 py-2 rounded-xl bg-gradient-to-r from-blood-500 to-rose-500 shadow-glow cursor-pointer">Book
            Donation</a>
        </div>
      </div>

      <!-- Tabs -->
      <section id="tab-dashboard" class="tab active mt-6">
        <div class="grid md:grid-cols-12 gap-6">
          <div class="md:col-span-8 grid sm:grid-cols-2 gap-4">
            <div class="glass p-5 rounded-2xl border border-white/10">
              <p class="text-sm text-slate-300">Last Donation</p>
              <p id="lastDonation" class="mt-1 text-2xl font-extrabold">‚Äî</p>
            </div>
            <div class="glass p-5 rounded-2xl border border-white/10">
              <p class="text-sm text-slate-300">Next Eligible</p>
              <p id="nextEligible" class="mt-1 text-2xl font-extrabold">‚Äî</p>
            </div>
            <div class="glass p-5 rounded-2xl border border-white/10">
              <p class="text-sm text-slate-300">Total Donations</p>
              <p id="totalDonations" class="mt-1 text-2xl font-extrabold">0</p>
            </div>
            <div class="glass p-5 rounded-2xl border border-white/10">
              <p class="text-sm text-slate-300">Lives Impacted (est.)</p>
              <p id="livesImpacted" class="mt-1 text-2xl font-extrabold">0</p>
            </div>
          </div>
          <div class="md:col-span-4">
            <div class="glass p-5 rounded-2xl border border-white/10 h-full">
              <h3 class="font-semibold">Your impact</h3>
              <p id="motivation" class="mt-2 text-slate-300 text-sm">Your donations may have helped 0 people. Keep
                going, hero!</p>
              <div class="mt-4 p-4 rounded-xl bg-white/5 border border-white/10 text-sm">
                <p class="text-slate-300">Next step</p>
                <p class="mt-1">Book your next donation when you‚Äôre eligible. We‚Äôll send you a reminder soon.</p>
                <a data-tab="schedule" class="mt-3 inline-block text-blood-400 hover:text-blood-50 cursor-pointer">Book
                  Donation ‚Üí</a>
              </div>
            </div>
          </div>
        </div>

        <div class="mt-8 grid lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 glass p-5 rounded-2xl border border-white/10">
            <h3 class="font-semibold">Quick tips</h3>
            <ul class="mt-3 list-disc list-inside text-sm text-slate-300 grid gap-1">
              <li>Hydrate well 24 hours before donating.</li>
              <li>Eat iron-rich foods like spinach and beans.</li>
              <li>Bring a valid photo ID for verification.</li>
            </ul>
          </div>
          <div class="glass p-5 rounded-2xl border border-white/10">
            <h3 class="font-semibold">Shortcuts</h3>
            <div class="mt-3 grid gap-2 text-sm">
              <a data-tab="history"
                class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 cursor-pointer">View
                Donation History</a>
              <a data-tab="profile"
                class="px-3 py-2 rounded-xl bg-white/5 border border-white/10 hover:bg-white/10 cursor-pointer">Edit
                Profile</a>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-schedule" class="tab mt-6">
        <div class="grid lg:grid-cols-3 gap-6">
          <!-- Booking -->
          <div class="lg:col-span-2 glass p-5 rounded-2xl border border-white/10">
            <div class="flex items-center justify-between gap-2">
              <h3 class="font-semibold">Schedule a donation</h3>
              <span class="text-xs text-slate-300">Choose type, location, date and time</span>
            </div>
            <div class="mt-4 grid sm:grid-cols-3 gap-3">
              <select id="donationType"
                class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:border-blood-500">
                <option>Blood</option>
                <option>Plasma</option>
                <option>Platelets</option>
              </select>
              <select id="donationLocation"
                class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:border-blood-500">
                <option>City Hall</option>
                <option>Community Clinic</option>
                <option>Red Cross Center</option>
              </select>
              <button id="todayBtn" class="px-3 py-2 rounded-xl border border-white/10 hover:bg-white/5">Jump to
                earliest date</button>
            </div>
            <div class="mt-5">
              <p class="text-sm text-slate-300">Select a date</p>
              <div id="dateChips" class="mt-2 flex gap-2 overflow-x-auto pb-1"></div>
            </div>
            <div class="mt-5">
              <p class="text-sm text-slate-300">Available times</p>
              <div id="slotGrid" class="mt-2 grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-2"></div>
              <p id="noSlots" class="hidden mt-2 text-sm text-slate-400">No slots available for this day.</p>
            </div>
            <p id="reschedHint" class="hidden mt-4 text-xs text-amber-300/90">Reschedule mode: pick a new time to update
              your appointment.</p>
          </div>

          <!-- Upcoming -->
          <div class="glass p-5 rounded-2xl border border-white/10">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Upcoming appointments</h3>
              <a data-tab="history" class="text-xs text-blood-400 hover:text-blood-50 cursor-pointer">History ‚Üí</a>
            </div>
            <div id="upcomingList" class="mt-3 grid gap-3"></div>
            <div id="noUpcoming" class="mt-3 text-sm text-slate-400">No upcoming appointments yet.</div>
          </div>
        </div>
      </section>

      <section id="tab-history" class="tab mt-6">
        <div class="grid lg:grid-cols-3 gap-6">
          <div class="lg:col-span-2 glass p-5 rounded-2xl border border-white/10">
            <div class="flex items-center justify-between gap-3">
              <h3 class="font-semibold">Donation history</h3>
              <button id="downloadAll"
                class="px-3 py-2 rounded-lg border border-white/10 hover:bg-white/5 text-sm">Download all</button>
            </div>
            <div class="mt-3 overflow-hidden rounded-xl border border-white/10">
              <table class="w-full text-sm">
                <thead class="bg-white/5 text-slate-300">
                  <tr>
                    <th class="text-left px-4 py-2">Date</th>
                    <th class="text-left px-4 py-2">Type</th>
                    <th class="text-left px-4 py-2">Location</th>
                    <th class="px-4 py-2">Certificate</th>
                  </tr>
                </thead>
                <tbody id="historyTable" class="divide-y divide-white/10"></tbody>
              </table>
            </div>
          </div>
          <div class="glass p-5 rounded-2xl border border-white/10">
            <h3 class="font-semibold">Timeline</h3>
            <div id="historyTimeline" class="mt-3">
              <!-- timeline entries injected here -->
            </div>
          </div>
        </div>
      </section>

      <section id="tab-profile" class="tab mt-6">
        <div class="grid lg:grid-cols-3 gap-6 items-start">
          <div class="lg:col-span-2 glass p-5 rounded-2xl border border-white/10">
            <h3 class="font-semibold">Personal information</h3>
            <form id="profileForm" class="mt-4 grid gap-3 text-sm">
              <div class="grid sm:grid-cols-2 gap-3">
                <input name="name" placeholder="Full name"
                  class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:border-blood-500">
                <input type="email" name="email" placeholder="Email address"
                  class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:border-blood-500">
              </div>
              <div class="grid sm:grid-cols-2 gap-3">
                <select name="group"
                  class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:border-blood-500">
                  <option value="">Blood Group</option>
                  <option>O+</option>
                  <option>O-</option>
                  <option>A+</option>
                  <option>A-</option>
                  <option>B+</option>
                  <option>B-</option>
                  <option>AB+</option>
                  <option>AB-</option>
                </select>
                <input name="city" placeholder="City"
                  class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:border-blood-500">
              </div>
              <div class="grid sm:grid-cols-2 gap-3">
                <input name="phone" placeholder="Phone"
                  class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:border-blood-500">
                <input name="address" placeholder="Address"
                  class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:border-blood-500">
              </div>
              <div class="flex items-center gap-2">
                <button class="shine px-4 py-2 rounded-xl bg-gradient-to-r from-blood-500 to-rose-500 shadow-glow">Save
                  changes</button>
                <span id="saveMsg" class="text-emerald-400 hidden">Saved!</span>
              </div>
            </form>
          </div>
          <div class="glass p-5 rounded-2xl border border-white/10">
            <h3 class="font-semibold">Emergency contact</h3>
            <form id="emergencyForm" class="mt-4 grid gap-3 text-sm">
              <input name="eName" placeholder="Contact name"
                class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:border-blood-500">
              <input name="ePhone" placeholder="Contact phone"
                class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:border-blood-500">
              <input name="eRelation" placeholder="Relation (e.g., Sister)"
                class="px-3 py-2 rounded-xl bg-white/10 border border-white/10 focus:outline-none focus:border-blood-500">
              <button class="px-4 py-2 rounded-xl border border-white/10 hover:bg-white/5">Save contact</button>
              <span id="emgMsg" class="text-emerald-400 hidden">Saved!</span>
            </form>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Auth guard
    const userRaw = localStorage.getItem('lifedrop_auth');
    if (!userRaw) { location.replace('signup.html?redirect=' + encodeURIComponent('portal.html')); }
    const user = userRaw ? JSON.parse(userRaw) : {};
    document.getElementById('userName').textContent = user.name || 'Donor';
    document.getElementById('userGroup').textContent = user.group ? (user.group + ' ‚Ä¢ ' + (user.city || '')) : (user.city || '');

    // Sidebar routing
    const links = Array.from(document.querySelectorAll('#sidebarLinks a, [data-tab]'));
    const tabs = {
      dashboard: document.getElementById('tab-dashboard'),
      schedule: document.getElementById('tab-schedule'),
      history: document.getElementById('tab-history'),
      profile: document.getElementById('tab-profile')
    };
    const setActive = (tab) => {
      Object.values(tabs).forEach(s => s.classList.remove('active'));
      tabs[tab]?.classList.add('active');
      document.getElementById('pageTitle').textContent = tab.charAt(0).toUpperCase() + tab.slice(1);
      links.forEach(a => {
        if (a.dataset.tab) { a.classList.toggle('bg-white/10', a.dataset.tab === tab); a.classList.toggle('border', a.dataset.tab === tab); a.classList.toggle('border-white/10', a.dataset.tab === tab); }
      });
      location.hash = tab;
    };


    // Schedule module logic
    const apptKey = 'lifedrop_appointments';
    const readAppts = () => JSON.parse(localStorage.getItem(apptKey) || '[]');
    const writeAppts = (arr) => localStorage.setItem(apptKey, JSON.stringify(arr));

    const dateChips = document.getElementById('dateChips');
    const slotGrid = document.getElementById('slotGrid');
    const noSlots = document.getElementById('noSlots');
    const upcomingList = document.getElementById('upcomingList');
    const noUpcoming = document.getElementById('noUpcoming');
    const todayBtn = document.getElementById('todayBtn');

    let selectedDate = null; // ISO date string (yyyy-mm-dd)
    let rescheduleId = null; // appointment id for reschedule mode

    const fmtDate = (d) => d.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
    const iso = (d) => d.toISOString().slice(0, 10);

    // Generate next 14 days chips
    const buildDates = () => {
      dateChips.innerHTML = '';
      const now = new Date(); now.setHours(0, 0, 0, 0);
      for (let i = 0; i < 14; i++) {
        const d = new Date(now.getTime() + i * 86400000);
        const chip = document.createElement('button');
        chip.className = 'px-3 py-2 rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 whitespace-nowrap';
        chip.textContent = fmtDate(d);
        chip.dataset.date = iso(d);
        chip.addEventListener('click', () => { selectedDate = chip.dataset.date; renderSlots(); highlightDate(); });
        dateChips.appendChild(chip);
        if (i === 0) { selectedDate = iso(d); }
      }
      highlightDate();
    };
    const highlightDate = () => {
      dateChips.querySelectorAll('button').forEach(b => {
        const active = b.dataset.date === selectedDate;
        b.classList.toggle('bg-white/10', active);
        b.classList.toggle('border-white/20', active);
      });
    };

    // Build slots per day (mock)
    const dailySlots = ['09:00', '09:30', '10:00', '10:30', '11:00', '11:30', '13:00', '13:30', '14:00', '14:30', '15:00'];
    const renderSlots = () => {
      slotGrid.innerHTML = '';
      noSlots.classList.add('hidden');
      if (!selectedDate) { noSlots.classList.remove('hidden'); return; }
      const appts = readAppts();
      const taken = new Set(appts.filter(a => a.date === selectedDate).map(a => a.time));
      let availableCount = 0;
      dailySlots.forEach(t => {
        const btn = document.createElement('button');
        const isTaken = taken.has(t);
        btn.className = 'px-3 py-2 rounded-xl border text-sm ' + (isTaken ? 'border-white/10 bg-white/5 text-slate-400 cursor-not-allowed' : 'border-white/10 bg-white/10 hover:bg-white/20');
        btn.textContent = t;
        btn.disabled = isTaken;
        btn.addEventListener('click', () => bookSlot(t));
        slotGrid.appendChild(btn);
        if (!isTaken) availableCount++;
      });
      if (availableCount === 0) noSlots.classList.remove('hidden');
    };

    // Booking / reschedule
    function bookSlot(time) {
      const type = document.getElementById('donationType').value;
      const locationName = document.getElementById('donationLocation').value;
      const appts = readAppts();
      if (rescheduleId) {
        const idx = appts.findIndex(a => a.id === rescheduleId);
        if (idx > -1) { appts[idx].date = selectedDate; appts[idx].time = time; appts[idx].type = type; appts[idx].location = locationName; }
        writeAppts(appts);
        rescheduleId = null; document.getElementById('reschedHint').classList.add('hidden');
      } else {
        const id = 'a_' + Math.random().toString(36).slice(2);
        appts.push({ id, date: selectedDate, time, type, location: locationName, createdAt: Date.now() });
        writeAppts(appts);
      }
      renderSlots(); renderUpcoming(); setActive('schedule');
    }

    function cancelAppt(id) { const appts = readAppts().filter(a => a.id !== id); writeAppts(appts); renderSlots(); renderUpcoming(); }
    function reschedAppt(id) { rescheduleId = id; document.getElementById('reschedHint').classList.remove('hidden'); setActive('schedule'); }

    const card = (a) => {
      const d = new Date(a.date + 'T' + a.time);
      const pretty = d.toLocaleString(undefined, { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
      return `<div class="p-4 rounded-xl bg-white/5 border border-white/10">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm text-slate-300">${a.type} ‚Ä¢ ${a.location}</div>
            <div class="font-semibold">${pretty}</div>
          </div>
          <div class="flex items-center gap-2 text-sm">
            <button data-act="resched" data-id="${a.id}" class="px-3 py-1.5 rounded-lg border border-white/10 hover:bg-white/5">Reschedule</button>
            <button data-act="cancel" data-id="${a.id}" class="px-3 py-1.5 rounded-lg border border-white/10 hover:bg-rose-500/20">Cancel</button>
          </div>
        </div>
      </div>`;
    };

    function renderUpcoming() {
      const appts = readAppts().sort((a, b) => (a.date + a.time).localeCompare(b.date + b.time));
      upcomingList.innerHTML = appts.map(card).join('');
      noUpcoming.classList.toggle('hidden', appts.length > 0);
      upcomingList.querySelectorAll('button').forEach(b => {
        const id = b.dataset.id; const act = b.dataset.act;
        if (act === 'cancel') b.addEventListener('click', () => cancelAppt(id));
        if (act === 'resched') b.addEventListener('click', () => reschedAppt(id));
      });
      renderSlots();
    }

    todayBtn.addEventListener('click', () => { selectedDate = iso(new Date()); highlightDate(); renderSlots(); });

    // Init schedule
    buildDates(); renderSlots(); renderUpcoming();


    // History module logic
    function getHistory() { return JSON.parse(localStorage.getItem('lifedrop_history') || '[]'); }
    const historyTable = document.getElementById('historyTable');
    const historyTimeline = document.getElementById('historyTimeline');

    function renderHistory() {
      const rows = getHistory().map((h, i) => {
        const d = new Date(h.date);
        const dateStr = d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
        return `<tr>
          <td class="px-4 py-2">${dateStr}</td>
          <td class="px-4 py-2">${h.type || 'Blood'}</td>
          <td class="px-4 py-2">${h.location || '-'}</td>
          <td class="px-4 py-2 text-center"><button class="px-3 py-1.5 rounded-lg border border-white/10 hover:bg-white/5 text-xs" data-cert="${i}">Download</button></td>
        </tr>`;
      }).join('');
      historyTable.innerHTML = rows || `<tr><td colspan="4" class="px-4 py-6 text-center text-slate-400">No donations yet.</td></tr>`;

      const items = getHistory().map(h => {
        const d = new Date(h.date);
        const pretty = d.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
        return `<div class="relative pl-6 py-3">
          <div class="absolute left-0 top-4 w-3 h-3 rounded-full bg-gradient-to-tr from-blood-500 to-rose-500"></div>
          <div class="text-sm text-slate-300">${pretty}</div>
          <div class="font-semibold">${h.type || 'Blood'} ‚Ä¢ ${h.location || '-'}</div>
        </div>`;
      }).join('');
      historyTimeline.innerHTML = items || '<div class="text-sm text-slate-400">No history yet.</div>';

      // Attach cert download handlers
      historyTable.querySelectorAll('button[data-cert]').forEach(btn => btn.addEventListener('click', () => downloadCert(parseInt(btn.dataset.cert, 10))));
    }

    function certHtml(entry) {
      const d = new Date(entry.date).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });
      const name = (user && user.name) || 'Donor';
      return `<!doctype html><html><head><meta charset="utf-8"><title>LifeDrop Certificate</title>
      <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
      <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
      <style>body{font-family:'Plus Jakarta Sans',system-ui;background:#0b0b10;color:#fff;margin:0;padding:40px} .card{max-width:800px;margin:0 auto;padding:40px;border-radius:24px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12)} .head{display:flex;align-items:center;gap:10px;font-weight:800;font-size:20px} .pill{padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.15);font-size:12px} .title{font-size:28px;font-weight:800;margin:16px 0} .muted{color:#cbd5e1} .row{margin-top:12px} .sig{margin-top:40px;display:flex;justify-content:space-between;align-items:center} .logo{width:24px;height:24px;background:linear-gradient(45deg,#ef4444,#f43f5e);border-radius:8px}</style><\/head>
      <body><div class="card"><div class="head"><div class="logo"></div> LifeDrop</div>
      <div class="pill">Donation Certificate</div>
      <div class="title">Thank you, ${name}!</div>
      <div class="muted">This certifies your ${entry.type || 'Blood'} donation on ${d} at ${entry.location || '-'}. Your generosity saves lives.</div>
      <div class="row muted">Certificate ID: ${'C-' + Math.random().toString(36).slice(2, 8).toUpperCase()}</div>
      <div class="sig"><div class="muted">Authorized by LifeDrop</div><div class="muted">lifedrop.example</div></div>
      </div><\/body><\/html>`;
    }

    function downloadCert(idx) {
      const h = getHistory(); const entry = h[idx]; if (!entry) return;
      const blob = new Blob([certHtml(entry)], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `lifedrop-certificate-${idx + 1}.html`; a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById('downloadAll').addEventListener('click', () => {
      const h = getHistory(); if (h.length === 0) return;
      const parts = h.map((e, i) => `<section style="margin:20px 0;padding:24px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06)">${certHtml(e)}</section>`).join('');
      const html = '<!doctype html><html><head><meta charset="utf-8"><title>LifeDrop ‚Äî All Certificates</title><\/head><body style="background:#0b0b10;color:#fff;font-family:system-ui,sans-serif;padding:24px">' + parts + '<\/body><\/html>';
      const blob = new Blob([html], { type: 'text/html' }); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'lifedrop-certificates.html'; a.click(); URL.revokeObjectURL(url);
    });

    // Render history on load and also when navigating to tab
    function onHashChange() { if (location.hash.replace('#', '') === 'history') { renderHistory(); } }
    window.addEventListener('hashchange', onHashChange);
    renderHistory();


    links.forEach(a => a.addEventListener('click', (e) => { const t = e.currentTarget.dataset.tab; if (t) { e.preventDefault(); setActive(t); } }));

    // Profile module logic
    const profileForm = document.getElementById('profileForm');
    const emergencyForm = document.getElementById('emergencyForm');

    function loadProfile() {
      const u = JSON.parse(localStorage.getItem('lifedrop_auth') || '{}');
      profileForm.name.value = u.name || '';
      if (profileForm.email) profileForm.email.value = u.email || '';
      if (profileForm.group) profileForm.group.value = u.group || '';
      if (profileForm.city) profileForm.city.value = u.city || '';
      if (profileForm.phone) profileForm.phone.value = u.phone || '';
      if (profileForm.address) profileForm.address.value = u.address || '';
      // Emergency
      const e = u.emergency || {};
      if (emergencyForm) {
        emergencyForm.eName.value = e.name || '';
        emergencyForm.ePhone.value = e.phone || '';
        emergencyForm.eRelation.value = e.relation || '';
      }
    }

    function saveProfile(e) {
      e.preventDefault();
      const u = JSON.parse(localStorage.getItem('lifedrop_auth') || '{}');
      u.name = profileForm.name.value.trim();
      u.email = profileForm.email.value.trim();
      u.group = profileForm.group.value;
      u.city = profileForm.city.value.trim();
      u.phone = profileForm.phone.value.trim();
      u.address = profileForm.address.value.trim();
      localStorage.setItem('lifedrop_auth', JSON.stringify(u));
      document.getElementById('userName').textContent = u.name || 'Donor';
      document.getElementById('userGroup').textContent = u.group ? (u.group + ' ‚Ä¢ ' + (u.city || '')) : (u.city || '');
      const msg = document.getElementById('saveMsg'); msg.classList.remove('hidden'); setTimeout(() => msg.classList.add('hidden'), 2000);
    }

    function saveEmergency(e) {
      e.preventDefault();
      const u = JSON.parse(localStorage.getItem('lifedrop_auth') || '{}');
      u.emergency = { name: emergencyForm.eName.value.trim(), phone: emergencyForm.ePhone.value.trim(), relation: emergencyForm.eRelation.value.trim() };
      localStorage.setItem('lifedrop_auth', JSON.stringify(u));
      const msg = document.getElementById('emgMsg'); msg.classList.remove('hidden'); setTimeout(() => msg.classList.add('hidden'), 2000);
    }

    profileForm.addEventListener('submit', saveProfile);
    emergencyForm.addEventListener('submit', saveEmergency);

    // Load on start and when entering tab
    loadProfile();
    window.addEventListener('hashchange', () => { if (location.hash.replace('#', '') === 'profile') { loadProfile(); } });

    const initial = location.hash?.replace('#', '') || 'dashboard'; setActive(initial);

    // Dashboard data population (mock/history-based)
    const history = JSON.parse(localStorage.getItem('lifedrop_history') || '[]');
    const fmt = (d) => new Date(d).toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    let total = history.length;
    let last = total ? history[history.length - 1].date : null;
    const gapDays = 90; // typical whole blood interval
    const nextEligible = last ? new Date(new Date(last).getTime() + gapDays * 24 * 60 * 60 * 1000) : null;
    document.getElementById('totalDonations').textContent = String(total);
    document.getElementById('livesImpacted').textContent = String(total * 3);
    document.getElementById('motivation').textContent = `Your donations may have helped ${total * 3} people. Keep going, hero!`;
    document.getElementById('lastDonation').textContent = last ? fmt(last) : 'No donations yet';
    document.getElementById('nextEligible').textContent = nextEligible ? fmt(nextEligible) : '‚Äî';

    // Demo: if no history, seed a sample for nicer UI preview (no network calls)
    if (history.length === 0) {
      const sample = [{ date: new Date(Date.now() - 120 * 86400000), type: 'Blood', location: 'City Hall' }, { date: new Date(Date.now() - 20 * 86400000), type: 'Plasma', location: 'Community Clinic' }];
      localStorage.setItem('lifedrop_history', JSON.stringify(sample));
      document.getElementById('totalDonations').textContent = '2';
      document.getElementById('livesImpacted').textContent = String(2 * 3);
      document.getElementById('motivation').textContent = `Your donations may have helped ${2 * 3} people. Keep going, hero!`;
      document.getElementById('lastDonation').textContent = fmt(sample[sample.length - 1].date);
      document.getElementById('nextEligible').textContent = fmt(new Date(new Date(sample[sample.length - 1].date).getTime() + 90 * 86400000));
    }

    // Logout
    document.getElementById('logout').addEventListener('click', () => { localStorage.removeItem('lifedrop_auth'); location.href = 'blood-donation-landing.html'; });
  </script>
</body>

</html>